name: Governance CI

on:
  pull_request:
  push:

jobs:
  governance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install runtime deps
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep
          python3 -m pip install --upgrade pip
          python3 -m pip install pyyaml

      - name: Resolve git diff range
        id: range
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            base="${{ github.event.pull_request.base.sha }}"
            head="${{ github.sha }}"
          else
            base="${{ github.event.before }}"
            head="${{ github.sha }}"
          fi

          if [[ -z "$base" || "$base" == "0000000000000000000000000000000000000000" ]]; then
            if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
              base="$(git rev-parse HEAD~1)"
            else
              base="$(git rev-parse HEAD)"
            fi
          fi

          echo "base=$base" >> "$GITHUB_OUTPUT"
          echo "head=$head" >> "$GITHUB_OUTPUT"
          echo "Resolved range: $base..$head"

      - name: Run governance verification bundle
        env:
          SIGEE_RUNTIME_ROOT: .sigee/.runtime
          SIGEE_VALIDATION_MODE: framework
        run: |
          bash skills/tech-planner/scripts/governance_ci.sh \
            --project-root . \
            --base-ref "${{ steps.range.outputs.base }}" \
            --head-ref "${{ steps.range.outputs.head }}"
