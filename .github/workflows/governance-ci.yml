name: Governance CI

on:
  pull_request:
  push:

jobs:
  governance-matrix:
    name: Governance (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ripgrep (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep

      - name: Install ripgrep (macOS)
        if: runner.os == 'macOS'
        run: brew install ripgrep

      - name: Install ripgrep (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: choco install ripgrep --yes --no-progress

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyyaml

      - name: Resolve git diff range
        id: range
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            base="${{ github.event.pull_request.base.sha }}"
            head="${{ github.sha }}"
          else
            base="${{ github.event.before }}"
            head="${{ github.sha }}"
          fi

          if [[ -z "$base" || "$base" == "0000000000000000000000000000000000000000" ]]; then
            if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
              base="$(git rev-parse HEAD~1)"
            else
              base="$(git rev-parse HEAD)"
            fi
          fi

          echo "base=$base" >> "$GITHUB_OUTPUT"
          echo "head=$head" >> "$GITHUB_OUTPUT"
          echo "Resolved range: $base..$head"

      - name: Verify skillpack CLI parity surface
        run: |
          node scripts/node/skillpack-cli.mjs deploy --all --dry-run --target .ci/tmp/deploy
          node scripts/node/skillpack-cli.mjs install --all --dry-run --target .ci/tmp/install --yes

      - name: Run governance verification bundle
        env:
          SIGEE_RUNTIME_ROOT: .sigee/.runtime
          SIGEE_VALIDATION_MODE: framework
        run: |
          bash skills/tech-planner/scripts/governance_ci.sh \
            --project-root . \
            --base-ref "${{ steps.range.outputs.base }}" \
            --head-ref "${{ steps.range.outputs.head }}"

  deployment-gate:
    name: Deployment Gate
    runs-on: ubuntu-latest
    needs:
      - governance-matrix
    if: always()
    steps:
      - name: Block deployment on governance failure
        run: |
          if [[ "${{ needs.governance-matrix.result }}" != "success" ]]; then
            echo "Cross-platform governance gate failed. Deployment is blocked."
            exit 1
          fi
          echo "Cross-platform governance gate passed. Deployment can proceed."
